name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: creator-split-paywall-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contracts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: contracts/package-lock.json
      - name: Install & Compile
        working-directory: ./contracts
        run: |
          npm ci --legacy-peer-deps
          npm run compile
      - name: Run contract tests
        working-directory: ./contracts
        run: npm test --silent

  backend-analytics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Prepare environment files for CI
        run: |
          # Root .env for postgres service
          cp .env.example .env
          sed -i 's/your_password/ci_test_password/g' .env
          sed -i 's/your_infura_key/dummy_infura_key/g' .env
          sed -i 's/your_private_key/0x0000000000000000000000000000000000000000000000000000000000000001/g' .env
          sed -i 's/your_jwt_secret/ci_test_jwt_secret/g' .env

          # Backend .env.docker
          cp backend/.env.prod.example backend/.env.docker
          sed -i 's/CHANGE_ME/ci_test_password/g' backend/.env.docker
          sed -i 's/your-project-id/dummy_infura_key/g' backend/.env.docker
          sed -i 's/your-super-secret-jwt-key-change-in-production/ci_test_jwt_secret/g' backend/.env.docker
          sed -i 's/your-analytics-webhook-token-change-in-production/super-secret-analytics-token-2025/g' backend/.env.docker
          sed -i 's/0x\.\.\./0x0000000000000000000000000000000000000000/g' backend/.env.docker
          # Disable blockchain polling in CI to avoid external RPC dependency / rate limits
          sed -i '/^ETH_RPC_URL=/d' backend/.env.docker

          # Analytics .env
          cp analytics/.env.example analytics/.env
          sed -i 's/your_password/ci_test_password/g' analytics/.env
          sed -i 's/your-analytics-webhook-token/super-secret-analytics-token-2025/g' analytics/.env
      - name: Build and start backend & analytics via docker compose
        run: |
          pwd
          ls -la backend/Dockerfile analytics/Dockerfile
          docker compose up -d --build backend analytics-worker analytics-beat
      - name: Wait for Postgres and create required extensions
        run: |
          ATTEMPTS=30
          until docker compose exec -T postgres pg_isready -U admin -d creator_split_db >/dev/null 2>&1 || [ $ATTEMPTS -eq 0 ]; do
            echo "Waiting for Postgres... ($ATTEMPTS)"; ATTEMPTS=$((ATTEMPTS-1)); sleep 5;
          done
          docker compose exec -T postgres psql -U admin -d creator_split_db -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
          docker compose exec -T postgres psql -U admin -d creator_split_db -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
      - name: Wait for backend to be responsive
        run: |
          ATTEMPTS=30
          until docker compose exec -T backend ls /usr/src/app/dist/main.js >/dev/null 2>&1 || [ $ATTEMPTS -eq 0 ]; do
            echo "Waiting for backend build... ($ATTEMPTS)"; ATTEMPTS=$((ATTEMPTS-1)); sleep 3;
          done
      - name: Run DB migrations
        run: |
          echo "Running TypeORM migrations..."
          docker compose exec -T backend npm run typeorm:migrate:run || (echo "Migration failed" && docker compose logs backend && exit 1)
      - name: Wait for backend health
        run: |
          ATTEMPTS=30
          until curl -sSf http://localhost:3000/health/ready >/dev/null || [ $ATTEMPTS -eq 0 ]; do
            echo "Waiting for backend... ($ATTEMPTS)"; ATTEMPTS=$((ATTEMPTS-1)); sleep 5;
          done
          curl -sSf http://localhost:3000/health/ready || (echo "Backend not healthy" && exit 1)
      - name: Validate env alignment
        run: |
          bash scripts/validate-env-alignment.sh
      - name: Run unified test suite (API + webhook)
        run: |
          bash scripts/test-all.sh http://localhost:3000
      - name: Run E2E anomaly scan
        run: |
          bash scripts/test-anomaly-e2e.sh http://localhost:3000 $(docker compose ps -q postgres) $(docker compose ps -q analytics-worker)
      - name: Archive backend logs (always)
        if: always()
        run: |
          docker compose logs backend > backend.log || true
          docker compose logs analytics-worker > analytics-worker.log || true
      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: |
            backend.log
            analytics-worker.log

  summary:
    runs-on: ubuntu-latest
    needs: [contracts, backend-analytics]
    if: always()
    steps:
      - name: Outcome summary
        run: |
          echo "Contracts job: ${{ needs.contracts.result }}"
          echo "Backend/Analytics job: ${{ needs.backend-analytics.result }}"
          if [ "${{ needs.contracts.result }}" != "success" ] || [ "${{ needs.backend-analytics.result }}" != "success" ]; then
            echo "One or more jobs failed"; exit 1; fi
