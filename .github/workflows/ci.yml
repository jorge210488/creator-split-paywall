name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: creator-split-paywall-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contracts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: contracts/package-lock.json
      - name: Install & Compile
        working-directory: ./contracts
        run: |
          npm ci --legacy-peer-deps
          npm run compile
      - name: Run contract tests
        working-directory: ./contracts
        run: npm test --silent

  backend-analytics:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:alpine
        ports: ["6379:6379"]
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: 18034783
          POSTGRES_DB: creator_split_db
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U admin -d creator_split_db" \
          --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Install backend deps
        working-directory: ./backend
        run: |
          npm ci --legacy-peer-deps
      - name: Build backend
        working-directory: ./backend
        run: |
          npm run build || echo "Build step optional / ignoring failures for now"
      - name: Install analytics python deps
        working-directory: ./analytics
        run: |
          pip install -r requirements.txt
      - name: Create pgcrypto extension
        run: |
          docker exec $(docker ps --filter "ancestor=postgres:13" --format '{{.ID}}') psql -U admin -d creator_split_db -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
      - name: Start backend & celery (docker compose)
        run: |
          docker compose up -d backend analytics-worker analytics-beat
      - name: Wait for backend health
        run: |
          ATTEMPTS=30
          until curl -sSf http://localhost:3000/health/ready >/dev/null || [ $ATTEMPTS -eq 0 ]; do
            echo "Waiting for backend... ($ATTEMPTS)"; ATTEMPTS=$((ATTEMPTS-1)); sleep 5;
          done
          curl -sSf http://localhost:3000/health/ready || (echo "Backend not healthy" && exit 1)
      - name: Validate env alignment
        run: |
          bash scripts/validate-env-alignment.sh
      - name: Run unified test suite (API + webhook)
        run: |
          bash scripts/test-all.sh http://localhost:3000
      - name: Run E2E anomaly scan
        run: |
          bash scripts/test-anomaly-e2e.sh http://localhost:3000 $(docker compose ps -q postgres) $(docker compose ps -q analytics-worker)
      - name: Archive backend logs (always)
        if: always()
        run: |
          docker compose logs backend > backend.log || true
          docker compose logs analytics-worker > analytics-worker.log || true
      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: |
            backend.log
            analytics-worker.log

  summary:
    runs-on: ubuntu-latest
    needs: [contracts, backend-analytics]
    if: always()
    steps:
      - name: Outcome summary
        run: |
          echo "Contracts job: ${{ needs.contracts.result }}"
          echo "Backend/Analytics job: ${{ needs.backend-analytics.result }}"
          if [ "${{ needs.contracts.result }}" != "success" ] || [ "${{ needs.backend-analytics.result }}" != "success" ]; then
            echo "One or more jobs failed"; exit 1; fi
